@model TheOtherSide.Models.Sale
@using System.Linq

@{
    ViewData["Title"] = "Pago";
    var grupos = Model.Cart
        .GroupBy(x => new { x.Id, x.Name, x.Price })
        .Select(g => new { g.Key.Id, g.Key.Name, g.Key.Price, Qty = g.Count(), Subtotal = g.Sum(i => i.Price) })
        .ToList();
    var total = grupos.Sum(x => x.Subtotal);
}

<h2 class="mb-3">Pago</h2>

@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-info">@TempData["SuccessMessage"]</div>
}

@if (!grupos.Any())
{
    <div class="alert alert-warning">No hay artículos en tu pedido.</div>
}
else
{
    <div class="row">
        <div class="col-md-7">
            <h5 class="mb-3">Resumen del pedido</h5>
            <table class="table align-middle">
                <thead>
                    <tr>
                        <th>Producto</th>
                        <th class="text-center">Cantidad</th>
                        <th class="text-end">Precio</th>
                        <th class="text-end">Subtotal</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var it in grupos)
                    {
                        <tr>
                            <td>@it.Name</td>
                            <td class="text-center">@it.Qty</td>
                            <td class="text-end">$@it.Price</td>
                            <td class="text-end">$@it.Subtotal</td>
                        </tr>
                    }
                </tbody>
                <tfoot>
                    <tr class="fw-bold">
                        <td colspan="4" class="text-end">Total</td>
                        <td class="text-end">$@total</td>
                    </tr>
                </tfoot>
            </table>
        </div>

        <div class="col-md-5">
            <h5 class="mb-3">Agregar tarjeta</h5>
            <form asp-action="ProcessPayment" method="post">
                <div class="mb-3">
                    <label class="form-label">Número de tarjeta</label>
                    <input name="cardNumber" class="form-control" placeholder="4111 1111 1111 1111" maxlength="16" inputmode="numeric" pattern="[0-9]{16}" required />
                </div>
                <div class="row g-3">
                    <div class="col">
                        <label class="form-label">Vencimiento (MM/AA)</label>
                        <input name="expiry" class="form-control" placeholder="08/28" required/>
                    </div>
                    <div class="col">
                        <label class="form-label">CVV</label>
                        <input name="cvv" class="form-control" placeholder="123" maxlength="3" inputmode="numeric" pattern="\d{3}" required/>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary w-100 mt-3">
                    Pagar
                </button>
                <div class="form-text mt-2">Demo: no almacenamos datos de tarjeta.</div>
            </form>
        </div>
    </div>
}
